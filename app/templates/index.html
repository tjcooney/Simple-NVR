{% extends "base.html" %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    {% for camera in cameras %}
    <div class="bg-white p-4 rounded-lg shadow">
        <h2 class="text-xl font-bold mb-2">{{ camera.name }}</h2>
        <div class="aspect-w-16 aspect-h-9 bg-black mb-4">
            <video id="video_{{ loop.index }}" class="w-full h-auto" muted autoplay playsinline></video>
        </div>
        <p class="text-gray-600 mb-2">Stream URL: {{ camera.stream_url }}</p>
        {% if camera.username %}
        <p class="text-gray-600 mb-2">Username: {{ camera.username }}</p>
        {% endif %}
        <div class="flex justify-between mt-4">
            <a href="{{ url_for('view_camera', camera_id=camera.id) }}" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-700">View Stream</a>
            <form action="{{ url_for('delete_camera', camera_id=camera.id) }}" method="POST" class="inline">
                <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-700" onclick="return confirm('Are you sure you want to delete this camera?')">Delete</button>
            </form>
        </div>
    </div>
    {% else %}
    <div class="col-span-3 text-center py-8">
        <p class="text-gray-600">No cameras found. Click "Add Camera" to get started.</p>
    </div>
    {% endfor %}
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% for camera in cameras %}
        var video = document.getElementById('video_{{ loop.index }}');
        var hls = new Hls({
            debug: true,
            manifestLoadingTimeOut: 20000,
            manifestLoadingMaxRetry: 3,
            manifestLoadingRetryDelay: 500,
        });

        var hlsUrl = 'http://{{ request.host.split(":")[0] }}:8080/hls/{{ camera.name }}.m3u8';
        console.log('Attempting to load HLS stream:', hlsUrl);

        if (Hls.isSupported()) {
            hls.loadSource(hlsUrl);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                console.log('HLS manifest parsed for {{ camera.name }}');
                video.play().catch(function(error) {
                    console.log('Playback failed for {{ camera.name }}:', error);
                });
            });

            // Error handling
            hls.on(Hls.Events.ERROR, function(event, data) {
                console.log('HLS error for {{ camera.name }}:', data);
                if (data.fatal) {
                    switch(data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            console.log('Network error for {{ camera.name }}, retrying...');
                            hls.startLoad();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            console.log('Media error for {{ camera.name }}, recovering...');
                            hls.recoverMediaError();
                            break;
                        default:
                            console.error('Fatal error for {{ camera.name }}, unrecoverable');
                            break;
                    }
                }
            });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = hlsUrl;
            video.addEventListener('loadedmetadata', function() {
                video.play();
            });
        }
        {% endfor %}
    });
</script>
{% endblock %}
